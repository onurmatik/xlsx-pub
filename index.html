<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Excel → Template Text Renderer</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Nunjucks templates in the browser -->
  <script src="https://cdn.jsdelivr.net/npm/nunjucks@3.2.4/browser/nunjucks.min.js"></script>

  <!-- SheetJS for parsing Excel in the browser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- FileSaver for download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    body { padding-top: 1rem; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h4 mb-0">Excel → Template Text Renderer</h1>
      <div class="d-flex gap-2">
        <button id="demoBtn" type="button" class="btn btn-outline-secondary btn-sm">Load demo data</button>
        <button id="testBtn" type="button" class="btn btn-outline-primary btn-sm">Run tests</button>
      </div>
    </div>

    <div class="row g-3">
      <!-- Left column -->
      <div class="col-md-5">
        <div class="card">
          <div class="card-header">Data & Template</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="excel" class="form-label">Upload Excel</label>
              <input id="excel" type="file" class="form-control" accept=".xlsx,.xls" />
              <div id="excelStatus" class="form-text">No file selected.</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Workbook summary</label>
              <div id="sheetSummary" class="border rounded p-2 bg-light" style="min-height:3rem;">
                <em class="text-muted">Upload a workbook to see sheets and columns here.</em>
              </div>
            </div>

            <div class="mb-3">
              <label for="tpl" class="form-label">Template</label>
              <textarea id="tpl" class="form-control" rows="12" placeholder="# Example YAML generated from Excel
sheets:
{% for key, s in sheets %}
  {{ s.name | lower | replace(' ', '_') }}:
    rows: {{ s.rows | length }}
    columns:
    {% for colName, values in s.cols %}
      - {{ colName | replace(' ', '_') }}
    {% endfor %}
{% endfor %}"></textarea>
              <div class="form-text">
                Use <nobr><code>sheets.&lt;sheetKey&gt;.rows</code></nobr> and <nobr><code>sheets.&lt;sheetKey&gt;.cols.&lt;column&gt;</code></nobr>.
              </div>
            </div>

            <div class="row g-2 align-items-end">
              <div class="col-7">
                <label for="outName" class="form-label">Output file name</label>
                <input id="outName" type="text" class="form-control" value="document.yaml" />
              </div>
              <div class="col-5 text-end">
                <button id="renderBtn" class="btn btn-primary" disabled>Render</button>
                <button id="downloadBtn" class="btn btn-success" disabled>Download</button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Right column -->
      <div class="col-md-7">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Output preview</span>
            <span id="renderStatus" class="text-muted small"></span>
          </div>
          <div class="card-body">
            <pre id="output" class="mb-0 text-body"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function initApp(){
      // ===== Nunjucks env =====
      if (!window.nunjucks) { alert('Nunjucks not loaded.'); throw new Error('Nunjucks not loaded'); }
      var env = new nunjucks.Environment();

      // ===== State =====
      var state = { workbook:null, sheets:{}, outputText:'' };

      // ===== Helpers =====
      function $(sel){ return document.querySelector(sel); }
      function nameKey(name){ return String(name).trim().toLowerCase().split(' ').join('_'); }

      function parseWorkbook(workbook){
        var result = {};
        workbook.SheetNames.forEach(function(name){
          var ws = workbook.Sheets[name];
          var rows = XLSX.utils.sheet_to_json(ws, { defval:"", raw:true });
          var cols = {};
          rows.forEach(function(r){ Object.keys(r).forEach(function(k){ (cols[k] = cols[k] || []).push(r[k]); }); });
          result[nameKey(name)] = { name: name, rows: rows, cols: cols };
        });
        return result;
      }

      function renderSheetSummary(){
        var box = $('#sheetSummary');
        box.innerHTML = '';
        var keys = Object.keys(state.sheets);
        if (!keys.length){ box.innerHTML = '<em class="text-muted">No workbook loaded.</em>'; return; }
        var ul = document.createElement('ul');
        ul.className = 'list-group list-group-flush';
        keys.forEach(function(k){
          var s = state.sheets[k];
          var li = document.createElement('li');
          li.className = 'list-group-item';
          li.innerHTML = '<div class="fw-semibold">'+s.name+' <span class="badge rounded-pill text-bg-secondary">'+s.rows.length+' rows</span></div>';
          var cols = Object.keys(s.cols);
          if (cols.length){
            var inner = document.createElement('ul');
            inner.className = 'mt-2 mb-0';
            cols.forEach(function(c){ var ci = document.createElement('li'); ci.textContent = c; inner.appendChild(ci); });
            li.appendChild(inner);
          }
          ul.appendChild(li);
        });
        box.appendChild(ul);
      }

      function enableRenderButtons(){ $('#renderBtn').disabled = !Object.keys(state.sheets).length; }
      function enableDownload(enable){ $('#downloadBtn').disabled = !enable; }

      function buildContext(){ return { sheets: state.sheets }; }

      function renderTemplate(){
        var tpl = $('#tpl').value || '';
        var ctx = buildContext();
        var text = env.renderString(tpl, ctx);
        state.outputText = text;
        $('#output').textContent = text;
        enableDownload(true);
        $('#renderStatus').textContent = 'Rendered 1 document.';
      }

      function download(){
        var name = ($('#outName').value || 'document.yaml').trim();
        var blob = new Blob([state.outputText || ''], { type: 'text/plain;charset=utf-8' });
        saveAs(blob, name);
      }

      // ===== Events =====
      $('#excel').addEventListener('change', function(ev){
        $('#output').textContent = '';
        enableDownload(false);
        var f = ev.target.files && ev.target.files[0];
        var stat = $('#excelStatus');
        if (!f){ state.workbook=null; state.sheets={}; renderSheetSummary(); enableRenderButtons(); stat.textContent='No file selected.'; return; }
        stat.textContent = 'Loading…';
        var reader = new FileReader();
        reader.onload = function(){
          try {
            var data = reader.result;
            var wb = XLSX.read(data, { type:'array' });
            state.workbook = wb; state.sheets = parseWorkbook(wb);
            renderSheetSummary();
            enableRenderButtons();
            stat.innerHTML = '<span class="text-success">Loaded:</span> '+ f.name;
          } catch (e){ console.error(e); stat.innerHTML = '<span class="text-danger">Error:</span> '+ e.message; }
        };
        reader.readAsArrayBuffer(f);
      });

      $('#renderBtn').addEventListener('click', renderTemplate);
      $('#downloadBtn').addEventListener('click', download);

      // Demo data
      $('#demoBtn').addEventListener('click', function(){
        var demo = {
          profile: { name:'profile', rows:[
            { name:'Ada Lovelace', city:'London' },
            { name:'Linus Torvalds', city:'Helsinki' },
            { name:'Guido van Rossum', city:'Amsterdam' }
          ], cols:{ name:['Ada Lovelace','Linus Torvalds','Guido van Rossum'], city:['London','Helsinki','Amsterdam'] } },
          items: { name:'items', rows:[
            { name:'Keyboard', category:'peripheral', color:'black' },
            { name:'Mouse', category:'peripheral', color:'white' },
            { name:'Monitor', category:'display', color:'black' },
            { name:'Laptop', category:'computer', color:'silver' },
            { name:'Cable', category:'accessory', color:'black' }
          ], cols:{ name:['Keyboard','Mouse','Monitor','Laptop','Cable'], category:['peripheral','peripheral','display','computer','accessory'], color:['black','white','black','silver','black'] } }
        };
        state.workbook = { demo:true }; state.sheets = demo;
        renderSheetSummary(); enableRenderButtons();
        $('#excelStatus').innerHTML = '<span class="text-success">Demo data loaded.</span>';
      });

      // Tests (basic sanity checks)
      $('#testBtn').addEventListener('click', function(){
        var pass = 0, fail = 0; var logs = [];
        if (!Object.keys(state.sheets).length) document.getElementById('demoBtn').click();

        // Test 1: summary lists sheet names and row counts
        var keys = Object.keys(state.sheets);
        if (keys.indexOf('profile') !== -1 && state.sheets.profile.rows.length === 3) pass++; else fail++;
        if (keys.indexOf('items') !== -1 && state.sheets.items.rows.length === 5) pass++; else fail++;
        logs.push('T1 summary ok');

        // Test 2: rendering produces exactly one document
        var tpl = 'count_items: {{ sheets.items.rows | length }}';
        var text = nunjucks.renderString(tpl, { sheets: state.sheets });
        if (typeof text === 'string' && text.indexOf('count_items: 5') !== -1) pass++; else fail++;
        logs.push('T2 single render ok');

        // Test 3: column list available
        if (Array.isArray(state.sheets.items.cols.name) && state.sheets.items.cols.name.length === 5) pass++; else fail++;
        logs.push('T3 cols ok');

        var status = document.createElement('div');
        status.className = 'alert ' + (fail ? 'alert-warning' : 'alert-success') + ' mt-2';
        status.textContent = 'Tests: ' + pass + ' passed, ' + fail + ' failed. ' + logs.join(' | ');
        $('#sheetSummary').appendChild(status);
      });

      // Initial summary
      renderSheetSummary(); enableRenderButtons();
    }
  </script>

  <!-- Bootstrap JS (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
