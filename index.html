<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Excel → Template Text Renderer</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Nunjucks templates in the browser -->
  <script src="https://cdn.jsdelivr.net/npm/nunjucks@3.2.4/browser/nunjucks.min.js"></script>

  <!-- SheetJS for parsing Excel in the browser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- FileSaver for download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    :root {
      --app-navbar-height: 3.5rem;
    }
    html,
    body {
      height: 100%;
    }
    body {
      padding-top: var(--app-navbar-height);
    }
    .app-navbar {
      height: var(--app-navbar-height);
    }
    .app-content {
      height: calc(100vh - var(--app-navbar-height));
      overflow: hidden;
      padding-top: 1rem;
      padding-bottom: 1rem;
      box-sizing: border-box;
    }
    .app-column {
      height: 100%;
      overflow-y: auto;
    }
    .app-split {
      position: relative;
      display: flex;
      flex-direction: row;
      align-items: stretch;
      gap: 1rem;
      height: 100%;
      --app-left-width: 33%;
    }
    .app-pane {
      min-width: 0;
    }
    .app-pane-left {
      flex: 0 0 var(--app-left-width);
      width: var(--app-left-width);
      max-width: var(--app-left-width);
    }
    .app-pane-right {
      flex: 1 1 auto;
      min-width: 0;
    }
    .app-divider {
      flex: 0 0 auto;
      width: 0.75rem;
      cursor: col-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      touch-action: none;
    }
    .app-divider::before {
      content: '';
      width: 2px;
      height: 60%;
      background-color: rgba(0, 0, 0, 0.1);
      border-radius: 1px;
    }
    .app-divider::after {
      content: '';
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 12px;
      height: 40px;
      border-radius: 0.75rem;
      background-color: transparent;
    }
    .app-divider:hover::after,
    .app-divider.is-active::after,
    .app-divider:focus-visible::after {
      background-color: rgba(13, 110, 253, 0.15);
    }
    .app-divider.is-active::before {
      background-color: #0d6efd;
    }
    .app-divider:focus-visible {
      outline: none;
    }
    pre { white-space: pre-wrap; word-break: break-word; }
    #tpl.drag-over {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    @media (max-width: 767.98px) {
      .app-content {
        height: auto;
        overflow: visible;
      }
      .app-split {
        height: auto;
        flex-direction: column;
      }
      .app-pane-left,
      .app-pane-right {
        flex: 1 1 auto;
        width: 100%;
        max-width: 100%;
      }
      .app-column {
        height: auto;
        overflow: visible;
      }
      .app-divider {
        display: none;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark fixed-top app-navbar">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">Excel → Template Text Renderer</span>
    </div>
  </nav>

  <main class="container-fluid app-content">
    <div class="app-split">
      <!-- Left column -->
      <div class="app-pane app-pane-left app-column" id="appDataPane">
        <div class="h-100">
          <h2 class="fs-5">Data & Template</h2>
          <hr>
          <div class="">
            <div class="mb-3">
              <label for="excel" class="form-label">Upload Excel</label>
              <input id="excel" type="file" class="form-control" accept=".xlsx,.xls" />
              <div id="excelStatus" class="form-text"></div>
            </div>

            <div id="workbookDetails" class="mb-3 d-none">
              <div class="border rounded p-2 bg-light">
                <div id="workbookTitle" class="fw-semibold"></div>
                <div id="sheetAccordion" class="accordion accordion-flush mt-2"></div>
              </div>
            </div>

            <div class="mb-3">
              <div class="d-flex flex-wrap align-items-center gap-2 mb-1">
                <div class="d-flex align-items-center gap-2">
                  <label for="tpl" class="form-label mb-0">Template</label>
                  <select id="tplSelect" class="form-select form-select-sm" aria-label="Choose template" style="min-width: 12rem;"></select>
                </div>
                <div class="ms-auto">
                  <button id="tplUploadBtn" type="button" class="btn btn-sm btn-outline-secondary">Upload file</button>
                  <button id="tplDownloadBtn" type="button" class="btn btn-sm btn-outline-secondary ms-2">Download template</button>
                  <input id="tplUpload" type="file" class="d-none" accept="text/*,.txt,.text,.md,.markdown,.njk,.nunjucks,.tmpl,.html,.htm,.json,.yaml,.yml,.csv,.tsv,.ini,.conf,.env" />
                </div>
              </div>
              <textarea id="tpl" class="form-control" rows="12"></textarea>
              <div class="form-text">
                Use <nobr><code>sheets.&lt;sheetKey&gt;.rows</code></nobr> and <nobr><code>sheets.&lt;sheetKey&gt;.cols.&lt;column&gt;</code></nobr>.
              </div>
              <div id="tplStatus" class="form-text text-muted" data-default-message="Drag &amp; drop a template text file here, upload one or choose from the template list.">Drag &amp; drop a template text file here, upload one or choose from the template list.</div>
            </div>

            <div class="mt-3 text-end">
              <button id="renderBtn" class="btn btn-primary" disabled>Render</button>
            </div>

          </div>
        </div>
      </div>

      <div class="app-divider" role="separator" aria-orientation="vertical" aria-label="Resize panels" aria-controls="appDataPane appPreviewPane" tabindex="0"></div>

      <!-- Right column -->
      <div class="app-pane app-pane-right app-column" id="appPreviewPane">
        <div class="h-100">
          <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
            <h2 class="fs-5 mb-0">Output preview</h2>
            <div class="ms-auto d-flex flex-wrap align-items-center gap-2">
              <label for="outName" class="form-label mb-0 visually-hidden">Output file name</label>
              <input id="outName" type="text" class="form-control" value="document.yaml" style="min-width: 12rem;" />
              <button id="downloadBtn" class="btn btn-success" disabled>Download</button>
            </div>
          </div>
          <hr>
          <pre id="output" class="mb-0 text-body">
          </pre>
        </div>
      </div>
    </div>
  </main>

  <script>
    function initApp(){
      // ===== Nunjucks env =====
      if (!window.nunjucks) { alert('Nunjucks not loaded.'); throw new Error('Nunjucks not loaded'); }
      var env = new nunjucks.Environment();

      // ===== State =====
      var state = { workbook:null, sheets:{}, outputText:'', fileName:'', templateName:'template.txt' };

      // ===== Helpers =====
      function $(sel){ return document.querySelector(sel); }
      function nameKey(name){ return String(name).trim().toLowerCase().split(' ').join('_'); }
      var tplArea = null;
      var tplStatusEl = null;
      var tplStatusDefault = '';
      var tplSelectEl = null;

      function getTplElements(){
        if (!tplArea) { tplArea = $('#tpl'); }
        if (!tplStatusEl) {
          tplStatusEl = $('#tplStatus');
          if (tplStatusEl) { tplStatusDefault = tplStatusEl.getAttribute('data-default-message') || tplStatusEl.textContent || ''; }
        }
      }

      function getTplSelect(){
        if (!tplSelectEl) { tplSelectEl = $('#tplSelect'); }
        return tplSelectEl;
      }

      function setTemplateSelectValue(value){
        var select = getTplSelect();
        if (!select) { return; }
        select.value = value || '';
      }

      function parseWorkbook(workbook){
        var result = {};
        workbook.SheetNames.forEach(function(name){
          var ws = workbook.Sheets[name];
          var rows = XLSX.utils.sheet_to_json(ws, { defval:"", raw:true });
          var cols = {};
          rows.forEach(function(r){ Object.keys(r).forEach(function(k){ (cols[k] = cols[k] || []).push(r[k]); }); });
          result[nameKey(name)] = { name: name, rows: rows, cols: cols };
        });
        return result;
      }

      function renderSheetSummary(){
        var wrapper = $('#workbookDetails');
        var titleEl = $('#workbookTitle');
        var accordion = $('#sheetAccordion');
        if (!wrapper || !titleEl || !accordion) { return; }

        accordion.innerHTML = '';
        var keys = Object.keys(state.sheets);
        if (!keys.length){
          wrapper.classList.add('d-none');
          titleEl.textContent = '';
          return;
        }

        wrapper.classList.remove('d-none');
        var sheetCount = keys.length;
        var sheetLabel = sheetCount === 1 ? '1 sheet' : sheetCount + ' sheets';
        var workbookLabel = state.fileName ? state.fileName + ' (' + sheetLabel + ')' : sheetLabel;
        titleEl.textContent = workbookLabel;

        var accordionParent = accordion.id ? ('#' + accordion.id) : '';
        keys.forEach(function(k, idx){
          var s = state.sheets[k];
          var colNames = Object.keys(s.cols);
          var colLabel = colNames.length === 1 ? '1 col' : colNames.length + ' cols';

          var item = document.createElement('div');
          item.className = 'accordion-item';

          var headerId = 'sheetHeading' + idx;
          var collapseId = 'sheetCollapse' + idx;

          var header = document.createElement('h2');
          header.className = 'accordion-header';
          header.id = headerId;

          var button = document.createElement('button');
          button.className = 'accordion-button collapsed';
          button.type = 'button';
          button.setAttribute('data-bs-toggle', 'collapse');
          button.setAttribute('data-bs-target', '#' + collapseId);
          button.setAttribute('aria-expanded', 'false');
          button.setAttribute('aria-controls', collapseId);
          button.textContent = s.name + ' (' + colLabel + ')';

          header.appendChild(button);
          item.appendChild(header);

          var collapse = document.createElement('div');
          collapse.id = collapseId;
          collapse.className = 'accordion-collapse collapse';
          collapse.setAttribute('aria-labelledby', headerId);

          var body = document.createElement('div');
          body.className = 'accordion-body py-2';

          if (colNames.length){
            var list = document.createElement('ul');
            list.className = 'list-unstyled mb-0 ps-3';
            colNames.forEach(function(col){
              var li = document.createElement('li');
              li.textContent = '- ' + col;
              list.appendChild(li);
            });
            body.appendChild(list);
          } else {
            var empty = document.createElement('div');
            empty.className = 'text-muted fst-italic ps-3';
            empty.textContent = 'No columns detected.';
            body.appendChild(empty);
          }

          collapse.appendChild(body);
          item.appendChild(collapse);
          accordion.appendChild(item);
        });
      }

      function enableRenderButtons(){ $('#renderBtn').disabled = !Object.keys(state.sheets).length; }
      function enableDownload(enable){ $('#downloadBtn').disabled = !enable; }

      function buildContext(){ return { sheets: state.sheets }; }

      function initResizableColumns(){
        var split = document.querySelector('.app-split');
        var leftPane = document.querySelector('.app-pane-left');
        var rightPane = document.querySelector('.app-pane-right');
        var divider = document.querySelector('.app-divider');
        if (!split || !leftPane || !rightPane || !divider) { return; }

        var minPercent = 20;
        var maxPercent = 80;
        var computed = parseFloat(getComputedStyle(split).getPropertyValue('--app-left-width'));
        var storedWidth = isNaN(computed) ? 41.6667 : computed;
        var activePointerId = null;
        var dragOffset = 0;

        divider.setAttribute('aria-valuemin', String(minPercent));
        divider.setAttribute('aria-valuemax', String(maxPercent));

        function isStacked(){
          return window.matchMedia('(max-width: 767.98px)').matches;
        }

        function clampWidth(value){
          if (value < minPercent) { return minPercent; }
          if (value > maxPercent) { return maxPercent; }
          return value;
        }

        function applyWidth(value){
          split.style.setProperty('--app-left-width', value + '%');
          divider.setAttribute('aria-valuenow', String(Math.round(value)));
        }

        function setWidth(value){
          var clamped = clampWidth(value);
          storedWidth = clamped;
          applyWidth(clamped);
        }

        function pointerMove(ev){
          if (activePointerId === null || ev.pointerId !== activePointerId) { return; }
          var rect = split.getBoundingClientRect();
          if (rect.width <= 0) { return; }
          var targetWidth = ev.clientX - rect.left - dragOffset;
          var percent = (targetWidth / rect.width) * 100;
          setWidth(percent);
          ev.preventDefault();
        }

        function endPointer(ev){
          if (activePointerId !== null && (!ev || ev.pointerId === activePointerId)) {
            try { divider.releasePointerCapture(activePointerId); } catch (err) { /* ignore */ }
            activePointerId = null;
          }
          divider.classList.remove('is-active');
        }

        divider.addEventListener('pointerdown', function(ev){
          if (isStacked()) { return; }
          var rect = split.getBoundingClientRect();
          if (rect.width <= 0) { return; }
          var leftPx = (storedWidth / 100) * rect.width;
          dragOffset = ev.clientX - rect.left - leftPx;
          activePointerId = ev.pointerId;
          divider.classList.add('is-active');
          divider.setPointerCapture(activePointerId);
          if (typeof divider.focus === 'function') { divider.focus(); }
          pointerMove(ev);
          ev.preventDefault();
        });
        divider.addEventListener('pointermove', pointerMove);
        divider.addEventListener('pointerup', endPointer);
        divider.addEventListener('pointercancel', endPointer);
        divider.addEventListener('lostpointercapture', endPointer);

        divider.addEventListener('keydown', function(ev){
          if (isStacked()) { return; }
          var step = ev.shiftKey ? 10 : 2;
          if (ev.key === 'ArrowLeft') {
            ev.preventDefault();
            setWidth(storedWidth - step);
          } else if (ev.key === 'ArrowRight') {
            ev.preventDefault();
            setWidth(storedWidth + step);
          } else if (ev.key === 'Home') {
            ev.preventDefault();
            setWidth(minPercent);
          } else if (ev.key === 'End') {
            ev.preventDefault();
            setWidth(maxPercent);
          }
        });

        divider.addEventListener('dblclick', function(){
          if (isStacked()) { return; }
          setWidth(50);
        });

        function handleLayoutChange(){
          if (activePointerId !== null) { endPointer(); }
          if (isStacked()) {
            split.style.setProperty('--app-left-width', '100%');
            divider.setAttribute('aria-hidden', 'true');
            divider.setAttribute('aria-valuenow', '100');
          } else {
            divider.removeAttribute('aria-hidden');
            applyWidth(storedWidth);
          }
        }

        window.addEventListener('resize', handleLayoutChange);
        handleLayoutChange();
      }

      function updateTplStatus(message, tone){
        getTplElements();
        if (!tplStatusEl) { return; }
        var text = message || tplStatusDefault;
        tplStatusEl.textContent = text;
        tplStatusEl.classList.remove('text-muted', 'text-success', 'text-danger');
        var toneClass = 'text-muted';
        if (tone === 'success') { toneClass = 'text-success'; }
        else if (tone === 'danger') { toneClass = 'text-danger'; }
        tplStatusEl.classList.add(toneClass);
      }

      function isTextTemplateFile(file){
        if (!file) { return false; }
        if (file.type && file.type.indexOf('text') === 0) { return true; }
        var name = file.name || '';
        var dot = name.lastIndexOf('.');
        var ext = dot >= 0 ? name.slice(dot + 1).toLowerCase() : '';
        var allowed = ['txt','text','md','markdown','njk','nunjucks','tmpl','mustache','hbs','html','htm','json','yaml','yml','csv','tsv','ini','conf','env'];
        return allowed.indexOf(ext) !== -1;
      }

      function loadTemplateFromFile(file){
        getTplElements();
        if (!file) { return; }
        if (!isTextTemplateFile(file)) {
          updateTplStatus('The file "' + (file.name || 'selected') + '" does not look like a text template.', 'danger');
          return;
        }
        state.templateName = file && file.name ? file.name : 'template.txt';
        var reader = new FileReader();
        reader.onload = function(){
          if (tplArea) {
            tplArea.value = reader.result || '';
            tplArea.focus();
          }
          setTemplateSelectValue('');
          updateTplStatus('Loaded template from ' + (file.name || 'file') + '.', 'success');
        };
        reader.onerror = function(){
          var errMsg = reader.error && reader.error.message ? reader.error.message : 'Unknown error';
          updateTplStatus('Could not read "' + (file.name || 'file') + '": ' + errMsg, 'danger');
        };
        reader.readAsText(file);
      }

      function loadTemplateFromText(text, note, templateName, selectValue){
        getTplElements();
        if (!tplArea) { return; }
        tplArea.value = text || '';
        tplArea.focus();
        state.templateName = templateName ? templateName : 'template.txt';
        setTemplateSelectValue(selectValue);
        updateTplStatus(note || 'Loaded dropped text.', 'success');
      }

      function renderTemplate(){
        var tpl = $('#tpl').value || '';
        var ctx = buildContext();
        var text = env.renderString(tpl, ctx);
        state.outputText = text;
        $('#output').textContent = text;
        enableDownload(true);
      }

      function download(){
        var name = ($('#outName').value || 'document.yaml').trim();
        var blob = new Blob([state.outputText || ''], { type: 'text/plain;charset=utf-8' });
        saveAs(blob, name);
      }

      function downloadTemplate(){
        getTplElements();
        if (!tplArea) { return; }
        var name = (state.templateName || '').trim() || 'template.txt';
        var blob = new Blob([tplArea.value || ''], { type: 'text/plain;charset=utf-8' });
        saveAs(blob, name);
        updateTplStatus('Downloaded template as ' + name + '.', 'success');
      }

      function formatTemplateLabel(file){
        var name = String(file || '');
        var parts = name.split('/');
        if (parts.length) { name = parts[parts.length - 1] || name; }
        var dot = name.lastIndexOf('.');
        if (dot > 0) { name = name.slice(0, dot); }
        name = name.replace(/[_-]+/g, ' ').replace(/\s+/g, ' ').trim();
        if (!name) { name = file; }
        return name.replace(/\b\w/g, function(chr){ return chr.toUpperCase(); });
      }

      function parseTemplateList(data){
        var rawList = [];
        if (Array.isArray(data)) {
          rawList = data;
        } else if (data && Array.isArray(data.templates)) {
          rawList = data.templates;
        }
        var entries = [];
        rawList.forEach(function(item){
          if (!item) { return; }
          if (typeof item === 'string') {
            entries.push({ file: item, label: formatTemplateLabel(item) });
            return;
          }
          if (typeof item === 'object') {
            var file = item.file || item.path || item.name;
            if (!file) { return; }
            var label = item.label || item.title || formatTemplateLabel(file);
            entries.push({ file: file, label: label });
          }
        });
        var seen = {};
        var unique = [];
        entries.forEach(function(entry){
          var file = entry.file;
          if (!file || seen[file]) { return; }
          seen[file] = true;
          unique.push(entry);
        });
        return unique;
      }

      function renderTemplateSelect(list, placeholder, disableSelect){
        var select = getTplSelect();
        if (!select) { return; }
        var currentValue = select.value;
        var fragment = document.createDocumentFragment();
        var placeholderOption = document.createElement('option');
        placeholderOption.value = '';
        placeholderOption.textContent = placeholder || '';
        fragment.appendChild(placeholderOption);
        var hasOptions = Array.isArray(list) && list.length > 0;
        if (hasOptions) {
          list.forEach(function(item){
            var option = document.createElement('option');
            option.value = item.file;
            option.textContent = item.label;
            option.setAttribute('data-label', item.label);
            fragment.appendChild(option);
          });
        }
        select.innerHTML = '';
        select.appendChild(fragment);
        var shouldDisable = disableSelect || !hasOptions;
        select.disabled = !!shouldDisable;
        if (!shouldDisable && currentValue) {
          var keepValue = false;
          list.forEach(function(item){ if (item.file === currentValue) { keepValue = true; } });
          if (keepValue) {
            setTemplateSelectValue(currentValue);
            return;
          }
        }
        setTemplateSelectValue('');
      }

      function buildTemplateUrl(file){
        var safeParts = String(file || '').split('/').filter(function(part){
          return part && part !== '.' && part !== '..';
        });
        return 'templates/' + safeParts.join('/');
      }

      function fetchTemplateList(){
        renderTemplateSelect([], 'Loading templates…', true);
        fetch('templates/index.json', { cache: 'no-store' })
          .then(function(resp){
            if (!resp.ok) { throw new Error('HTTP ' + resp.status); }
            return resp.json();
          })
          .then(function(data){
            var list = parseTemplateList(data);
            if (list.length) {
              renderTemplateSelect(list, 'Choose a template…', false);
            } else {
              renderTemplateSelect([], 'No templates available', true);
            }
          })
          .catch(function(err){
            console.warn('Unable to load template index.', err);
            renderTemplateSelect([], 'Templates unavailable', true);
          });
      }

      function handleTemplateSelection(ev){
        var select = ev.target || ev.currentTarget;
        if (!select) { return; }
        var file = select.value;
        if (!file) { return; }
        var option = select.options[select.selectedIndex];
        var label = option ? (option.getAttribute('data-label') || option.textContent || file) : file;
        updateTplStatus('Loading template "' + label + '"…');
        fetch(buildTemplateUrl(file), { cache: 'no-store' })
          .then(function(resp){
            if (!resp.ok) { throw new Error('HTTP ' + resp.status); }
            return resp.text();
          })
          .then(function(text){
            var nameParts = file.split('/');
            var baseName = nameParts.length ? (nameParts[nameParts.length - 1] || file) : file;
            loadTemplateFromText(text, 'Loaded template "' + label + '" from the template list.', baseName, file);
          })
          .catch(function(err){
            console.error(err);
            updateTplStatus('Could not load template "' + label + '": ' + err.message, 'danger');
            setTemplateSelectValue('');
          });
      }

      // ===== Events =====
      $('#excel').addEventListener('change', function(ev){
        $('#output').textContent = '';
        enableDownload(false);
        var f = ev.target.files && ev.target.files[0];
        var stat = $('#excelStatus');

        if (!f){
          state.workbook = null;
          state.sheets = {};
          state.fileName = '';
          renderSheetSummary();
          enableRenderButtons();
          if (stat){
            stat.textContent = 'No file selected.';
            stat.classList.remove('d-none');
          }
          return;
        }

        state.workbook = null;
        state.sheets = {};
        state.fileName = '';
        renderSheetSummary();
        enableRenderButtons();

        if (stat){
          stat.textContent = 'Loading…';
          stat.classList.remove('d-none');
        }

        var reader = new FileReader();
        reader.onload = function(){
          try {
            var data = reader.result;
            var wb = XLSX.read(data, { type:'array' });
            state.workbook = wb;
            state.sheets = parseWorkbook(wb);
            state.fileName = f.name || '';
            renderSheetSummary();
            enableRenderButtons();
            if (stat){
              stat.textContent = '';
              stat.classList.add('d-none');
            }
          } catch (e){
            console.error(e);
            state.workbook = null;
            state.sheets = {};
            state.fileName = '';
            renderSheetSummary();
            enableRenderButtons();
            if (stat){
              stat.innerHTML = '<span class="text-danger">Error:</span> ' + e.message;
              stat.classList.remove('d-none');
            }
          }
        };
        reader.onerror = function(){
          state.workbook = null;
          state.sheets = {};
          state.fileName = '';
          renderSheetSummary();
          enableRenderButtons();
          var errMsg = reader.error && reader.error.message ? reader.error.message : 'Unknown error';
          if (stat){
            stat.innerHTML = '<span class="text-danger">Error:</span> ' + errMsg;
            stat.classList.remove('d-none');
          }
        };
        reader.readAsArrayBuffer(f);
      });

      $('#renderBtn').addEventListener('click', renderTemplate);
      $('#downloadBtn').addEventListener('click', download);

      // Template upload helpers
      getTplElements();
      updateTplStatus();
      initResizableColumns();
      var tplUploadBtn = $('#tplUploadBtn');
      var tplDownloadBtn = $('#tplDownloadBtn');
      var tplUploadInput = $('#tplUpload');
      if (tplUploadBtn && tplUploadInput) {
        tplUploadBtn.addEventListener('click', function(){ tplUploadInput.click(); });
        tplUploadInput.addEventListener('change', function(ev){
          var file = ev.target.files && ev.target.files[0];
          if (file) { loadTemplateFromFile(file); }
          ev.target.value = '';
        });
      }
      if (tplDownloadBtn) {
        tplDownloadBtn.addEventListener('click', downloadTemplate);
      }

      var tplSelect = getTplSelect();
      if (tplSelect) {
        tplSelect.addEventListener('change', handleTemplateSelection);
      }
      fetchTemplateList();

      if (tplArea) {
        tplArea.addEventListener('dragover', function(ev){
          ev.preventDefault();
          if (ev.dataTransfer) { ev.dataTransfer.dropEffect = 'copy'; }
          tplArea.classList.add('drag-over');
        });
        tplArea.addEventListener('dragleave', function(){ tplArea.classList.remove('drag-over'); });
        tplArea.addEventListener('dragend', function(){ tplArea.classList.remove('drag-over'); });
        tplArea.addEventListener('drop', function(ev){
          ev.preventDefault();
          tplArea.classList.remove('drag-over');
          var dt = ev.dataTransfer;
          if (!dt) { return; }
          if (dt.files && dt.files.length) {
            loadTemplateFromFile(dt.files[0]);
            return;
          }
          var text = dt.getData && dt.getData('text/plain');
          if (text) {
            loadTemplateFromText(text, 'Loaded dropped text snippet.');
          }
        });
      }

      // Initial summary
      renderSheetSummary(); enableRenderButtons();
    }

    // Run once (libs are already loaded from <head>)
    initApp();
  </script>

  <!-- Bootstrap JS (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
