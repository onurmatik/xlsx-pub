<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Excel → Template Text Renderer</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Nunjucks templates in the browser -->
  <script src="https://cdn.jsdelivr.net/npm/nunjucks@3.2.4/browser/nunjucks.min.js"></script>

  <!-- SheetJS for parsing Excel in the browser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- FileSaver for download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    :root {
      --app-navbar-height: 3.5rem;
    }
    html,
    body {
      height: 100%;
    }
    body {
      padding-top: var(--app-navbar-height);
    }
    .app-navbar {
      height: var(--app-navbar-height);
    }
    .app-content {
      height: calc(100vh - var(--app-navbar-height));
      overflow: hidden;
      padding-top: 1rem;
      padding-bottom: 1rem;
      box-sizing: border-box;
    }
    .app-row {
      height: 100%;
    }
    .app-column {
      height: 100%;
      overflow-y: auto;
    }
    pre { white-space: pre-wrap; word-break: break-word; }
    #tpl.drag-over {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    @media (max-width: 767.98px) {
      .app-content {
        height: auto;
        overflow: visible;
      }
      .app-row {
        height: auto;
      }
      .app-column {
        height: auto;
        overflow: visible;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark fixed-top app-navbar">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">Excel → Template Text Renderer</span>
    </div>
  </nav>

  <main class="container-fluid app-content">
    <div class="row g-3 app-row">
      <!-- Left column -->
      <div class="col-md-5 app-column">
        <div class="card h-100">
          <div class="card-header">Data & Template</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="excel" class="form-label">Upload Excel</label>
              <input id="excel" type="file" class="form-control" accept=".xlsx,.xls" />
              <div id="excelStatus" class="form-text">No file selected.</div>
            </div>

            <div id="workbookDetails" class="mb-3 d-none">
              <div class="border rounded p-2 bg-light">
                <div id="workbookTitle" class="fw-semibold"></div>
                <div id="sheetAccordion" class="accordion accordion-flush mt-2"></div>
              </div>
            </div>

            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <label for="tpl" class="form-label mb-0">Template</label>
                <div>
                  <button id="tplUploadBtn" type="button" class="btn btn-sm btn-outline-secondary">Upload file</button>
                  <button id="tplDownloadBtn" type="button" class="btn btn-sm btn-outline-secondary ms-2">Download template</button>
                  <input id="tplUpload" type="file" class="d-none" accept="text/*,.txt,.text,.md,.markdown,.njk,.nunjucks,.tmpl,.html,.htm,.json,.yaml,.yml,.csv,.tsv,.ini,.conf,.env" />
                </div>
              </div>
              <textarea id="tpl" class="form-control" rows="12" placeholder="# Example YAML generated from Excel
sheets:
{% for key, s in sheets %}
  {{ s.name | lower | replace(' ', '_') }}:
    rows: {{ s.rows | length }}
    columns:
    {% for colName, values in s.cols %}
      - {{ colName | replace(' ', '_') }}
    {% endfor %}
    {% endfor %}"></textarea>
              <div class="form-text">
                Use <nobr><code>sheets.&lt;sheetKey&gt;.rows</code></nobr> and <nobr><code>sheets.&lt;sheetKey&gt;.cols.&lt;column&gt;</code></nobr>.
              </div>
              <div id="tplStatus" class="form-text text-muted" data-default-message="Drag &amp; drop a text file here or upload one.">Drag &amp; drop a text file here or upload one.</div>
            </div>

            <div class="row g-2 align-items-end">
              <div class="col-7">
                <label for="outName" class="form-label">Output file name</label>
                <input id="outName" type="text" class="form-control" value="document.yaml" />
              </div>
              <div class="col-5 text-end">
                <button id="renderBtn" class="btn btn-primary" disabled>Render</button>
                <button id="downloadBtn" class="btn btn-success" disabled>Download</button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Right column -->
      <div class="col-md-7 app-column">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Output preview</span>
          </div>
          <div class="card-body">
            <pre id="output" class="mb-0 text-body"></pre>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    function initApp(){
      // ===== Nunjucks env =====
      if (!window.nunjucks) { alert('Nunjucks not loaded.'); throw new Error('Nunjucks not loaded'); }
      var env = new nunjucks.Environment();

      // ===== State =====
      var state = { workbook:null, sheets:{}, outputText:'', fileName:'', templateName:'template.txt' };

      // ===== Helpers =====
      function $(sel){ return document.querySelector(sel); }
      function nameKey(name){ return String(name).trim().toLowerCase().split(' ').join('_'); }
      var tplArea = null;
      var tplStatusEl = null;
      var tplStatusDefault = '';

      function getTplElements(){
        if (!tplArea) { tplArea = $('#tpl'); }
        if (!tplStatusEl) {
          tplStatusEl = $('#tplStatus');
          if (tplStatusEl) { tplStatusDefault = tplStatusEl.getAttribute('data-default-message') || tplStatusEl.textContent || ''; }
        }
      }

      function parseWorkbook(workbook){
        var result = {};
        workbook.SheetNames.forEach(function(name){
          var ws = workbook.Sheets[name];
          var rows = XLSX.utils.sheet_to_json(ws, { defval:"", raw:true });
          var cols = {};
          rows.forEach(function(r){ Object.keys(r).forEach(function(k){ (cols[k] = cols[k] || []).push(r[k]); }); });
          result[nameKey(name)] = { name: name, rows: rows, cols: cols };
        });
        return result;
      }

      function renderSheetSummary(){
        var wrapper = $('#workbookDetails');
        var titleEl = $('#workbookTitle');
        var accordion = $('#sheetAccordion');
        if (!wrapper || !titleEl || !accordion) { return; }

        accordion.innerHTML = '';
        var keys = Object.keys(state.sheets);
        if (!keys.length){
          wrapper.classList.add('d-none');
          titleEl.textContent = '';
          return;
        }

        wrapper.classList.remove('d-none');
        var sheetCount = keys.length;
        var sheetLabel = sheetCount === 1 ? '1 sheet' : sheetCount + ' sheets';
        var workbookLabel = state.fileName ? state.fileName + ' (' + sheetLabel + ')' : sheetLabel;
        titleEl.textContent = workbookLabel;

        var accordionParent = accordion.id ? ('#' + accordion.id) : '';
        keys.forEach(function(k, idx){
          var s = state.sheets[k];
          var colNames = Object.keys(s.cols);
          var colLabel = colNames.length === 1 ? '1 col' : colNames.length + ' cols';

          var item = document.createElement('div');
          item.className = 'accordion-item';

          var headerId = 'sheetHeading' + idx;
          var collapseId = 'sheetCollapse' + idx;

          var header = document.createElement('h2');
          header.className = 'accordion-header';
          header.id = headerId;

          var button = document.createElement('button');
          button.className = 'accordion-button collapsed';
          button.type = 'button';
          button.setAttribute('data-bs-toggle', 'collapse');
          button.setAttribute('data-bs-target', '#' + collapseId);
          button.setAttribute('aria-expanded', 'false');
          button.setAttribute('aria-controls', collapseId);
          button.textContent = s.name + ' (' + colLabel + ')';

          header.appendChild(button);
          item.appendChild(header);

          var collapse = document.createElement('div');
          collapse.id = collapseId;
          collapse.className = 'accordion-collapse collapse';
          collapse.setAttribute('aria-labelledby', headerId);
          if (accordionParent) { collapse.setAttribute('data-bs-parent', accordionParent); }

          var body = document.createElement('div');
          body.className = 'accordion-body py-2';

          if (colNames.length){
            var list = document.createElement('ul');
            list.className = 'list-unstyled mb-0 ps-3';
            colNames.forEach(function(col){
              var li = document.createElement('li');
              li.textContent = '- ' + col;
              list.appendChild(li);
            });
            body.appendChild(list);
          } else {
            var empty = document.createElement('div');
            empty.className = 'text-muted fst-italic ps-3';
            empty.textContent = 'No columns detected.';
            body.appendChild(empty);
          }

          collapse.appendChild(body);
          item.appendChild(collapse);
          accordion.appendChild(item);
        });
      }

      function enableRenderButtons(){ $('#renderBtn').disabled = !Object.keys(state.sheets).length; }
      function enableDownload(enable){ $('#downloadBtn').disabled = !enable; }

      function buildContext(){ return { sheets: state.sheets }; }

      function updateTplStatus(message, tone){
        getTplElements();
        if (!tplStatusEl) { return; }
        var text = message || tplStatusDefault;
        tplStatusEl.textContent = text;
        tplStatusEl.classList.remove('text-muted', 'text-success', 'text-danger');
        var toneClass = 'text-muted';
        if (tone === 'success') { toneClass = 'text-success'; }
        else if (tone === 'danger') { toneClass = 'text-danger'; }
        tplStatusEl.classList.add(toneClass);
      }

      function isTextTemplateFile(file){
        if (!file) { return false; }
        if (file.type && file.type.indexOf('text') === 0) { return true; }
        var name = file.name || '';
        var dot = name.lastIndexOf('.');
        var ext = dot >= 0 ? name.slice(dot + 1).toLowerCase() : '';
        var allowed = ['txt','text','md','markdown','njk','nunjucks','tmpl','mustache','hbs','html','htm','json','yaml','yml','csv','tsv','ini','conf','env'];
        return allowed.indexOf(ext) !== -1;
      }

      function loadTemplateFromFile(file){
        getTplElements();
        if (!file) { return; }
        if (!isTextTemplateFile(file)) {
          updateTplStatus('The file "' + (file.name || 'selected') + '" does not look like a text template.', 'danger');
          return;
        }
        state.templateName = file && file.name ? file.name : 'template.txt';
        var reader = new FileReader();
        reader.onload = function(){
          if (tplArea) {
            tplArea.value = reader.result || '';
            tplArea.focus();
          }
          updateTplStatus('Loaded template from ' + (file.name || 'file') + '.', 'success');
        };
        reader.onerror = function(){
          var errMsg = reader.error && reader.error.message ? reader.error.message : 'Unknown error';
          updateTplStatus('Could not read "' + (file.name || 'file') + '": ' + errMsg, 'danger');
        };
        reader.readAsText(file);
      }

      function loadTemplateFromText(text, note){
        getTplElements();
        if (!tplArea) { return; }
        tplArea.value = text || '';
        tplArea.focus();
        state.templateName = 'template.txt';
        updateTplStatus(note || 'Loaded dropped text.', 'success');
      }

      function renderTemplate(){
        var tpl = $('#tpl').value || '';
        var ctx = buildContext();
        var text = env.renderString(tpl, ctx);
        state.outputText = text;
        $('#output').textContent = text;
        enableDownload(true);
      }

      function download(){
        var name = ($('#outName').value || 'document.yaml').trim();
        var blob = new Blob([state.outputText || ''], { type: 'text/plain;charset=utf-8' });
        saveAs(blob, name);
      }

      function downloadTemplate(){
        getTplElements();
        if (!tplArea) { return; }
        var name = (state.templateName || '').trim() || 'template.txt';
        var blob = new Blob([tplArea.value || ''], { type: 'text/plain;charset=utf-8' });
        saveAs(blob, name);
        updateTplStatus('Downloaded template as ' + name + '.', 'success');
      }

      // ===== Events =====
      $('#excel').addEventListener('change', function(ev){
        $('#output').textContent = '';
        enableDownload(false);
        var f = ev.target.files && ev.target.files[0];
        var stat = $('#excelStatus');

        if (!f){
          state.workbook = null;
          state.sheets = {};
          state.fileName = '';
          renderSheetSummary();
          enableRenderButtons();
          if (stat){
            stat.textContent = 'No file selected.';
            stat.classList.remove('d-none');
          }
          return;
        }

        state.workbook = null;
        state.sheets = {};
        state.fileName = '';
        renderSheetSummary();
        enableRenderButtons();

        if (stat){
          stat.textContent = 'Loading…';
          stat.classList.remove('d-none');
        }

        var reader = new FileReader();
        reader.onload = function(){
          try {
            var data = reader.result;
            var wb = XLSX.read(data, { type:'array' });
            state.workbook = wb;
            state.sheets = parseWorkbook(wb);
            state.fileName = f.name || '';
            renderSheetSummary();
            enableRenderButtons();
            if (stat){
              stat.textContent = '';
              stat.classList.add('d-none');
            }
          } catch (e){
            console.error(e);
            state.workbook = null;
            state.sheets = {};
            state.fileName = '';
            renderSheetSummary();
            enableRenderButtons();
            if (stat){
              stat.innerHTML = '<span class="text-danger">Error:</span> ' + e.message;
              stat.classList.remove('d-none');
            }
          }
        };
        reader.onerror = function(){
          state.workbook = null;
          state.sheets = {};
          state.fileName = '';
          renderSheetSummary();
          enableRenderButtons();
          var errMsg = reader.error && reader.error.message ? reader.error.message : 'Unknown error';
          if (stat){
            stat.innerHTML = '<span class="text-danger">Error:</span> ' + errMsg;
            stat.classList.remove('d-none');
          }
        };
        reader.readAsArrayBuffer(f);
      });

      $('#renderBtn').addEventListener('click', renderTemplate);
      $('#downloadBtn').addEventListener('click', download);

      // Template upload helpers
      getTplElements();
      updateTplStatus();
      var tplUploadBtn = $('#tplUploadBtn');
      var tplDownloadBtn = $('#tplDownloadBtn');
      var tplUploadInput = $('#tplUpload');
      if (tplUploadBtn && tplUploadInput) {
        tplUploadBtn.addEventListener('click', function(){ tplUploadInput.click(); });
        tplUploadInput.addEventListener('change', function(ev){
          var file = ev.target.files && ev.target.files[0];
          if (file) { loadTemplateFromFile(file); }
          ev.target.value = '';
        });
      }
      if (tplDownloadBtn) {
        tplDownloadBtn.addEventListener('click', downloadTemplate);
      }

      if (tplArea) {
        tplArea.addEventListener('dragover', function(ev){
          ev.preventDefault();
          if (ev.dataTransfer) { ev.dataTransfer.dropEffect = 'copy'; }
          tplArea.classList.add('drag-over');
        });
        tplArea.addEventListener('dragleave', function(){ tplArea.classList.remove('drag-over'); });
        tplArea.addEventListener('dragend', function(){ tplArea.classList.remove('drag-over'); });
        tplArea.addEventListener('drop', function(ev){
          ev.preventDefault();
          tplArea.classList.remove('drag-over');
          var dt = ev.dataTransfer;
          if (!dt) { return; }
          if (dt.files && dt.files.length) {
            loadTemplateFromFile(dt.files[0]);
            return;
          }
          var text = dt.getData && dt.getData('text/plain');
          if (text) {
            loadTemplateFromText(text, 'Loaded dropped text snippet.');
          }
        });
      }

      // Initial summary
      renderSheetSummary(); enableRenderButtons();
    }

    // Run once (libs are already loaded from <head>)
    initApp();
  </script>

  <!-- Bootstrap JS (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
